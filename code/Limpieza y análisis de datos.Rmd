---
title: "PRACTICA 2: LIMPIEZA Y VALIDACIÓN DE LOS DATOS"
author: "Gines Molina e Iñigo Alvarez"
date: "29/12/2020"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Hello

```{r load, include=FALSE}
# Carga de librerías
library(dplyr)
library(ggplot2)
library(VIM)
library(highcharter)
library(maps)
library(ggmap)
```

# 1. Descripción del dataset

El dataset es un listado de ofertas de trabajo publicadas en Linkedin para ciencia de datos (término "Data Scientist") que fue obtenido en la primera parte de esta práctica.

Consta de 6 archivos CSV con las ofertas encontradas a nivel de Escocia, Reino Unido, España, Mundo y remoto.

# 2. Integración y selección de los datos de interés a analizar

El primer paso es integrar los distintos archivos en un mismo dataset.

```{r}
Scotland <- read.csv("data/Scotland.csv", header=TRUE, sep=",", stringsAsFactors=FALSE)
Spain <- read.csv("data/Spain.csv", header=TRUE, sep=",", stringsAsFactors=FALSE)
UK <- read.csv("data/UK.csv", header=TRUE, sep=",", stringsAsFactors=FALSE)
WorldWide <- read.csv("data/WorldWide.csv", header=TRUE, sep=",", stringsAsFactors=FALSE)
Remote <- read.csv("data/Remote.csv", header=TRUE, sep=",", stringsAsFactors=FALSE)
jobs <- rbind(Scotland, Spain, UK, WorldWide, Remote)
```

```{r}
str(jobs)
```

Quitamos la primera columna ya que no es más que un índice que no aporta ninguna información.

```{r}
jobs <- jobs[2:17]
```

Cambiamos a numéricas las columnas que deberían ser de este tipo pero se ven como "character".

```{r}

```

Discretización y poner en varias variables con variables binarias (1 y 0)

```{r}

```

# 3. Limpieza de los datos

Al haber integrado varios archivos de búsquedas de ámbitos territoriales que se solapan lo primero es eliminar las posibles duplicidades que podamos encontrar.

```{r}
sum(duplicated(jobs))
```

Hay `r sum(duplicated(jobs))` observaciones duplicadas así que las eliminamos.

```{r}
jobs <- distinct(jobs)
```

# 3.1. Valores perdidos

Buscamos valores perdidos.

```{r}
sum(is.na(jobs))
sum(jobs=="")
sum(jobs=="None")
```

Sustituimos los valores en blanco por NA.

```{r}
jobs[jobs==""] <-- NA
jobs[jobs=="None"] <-- NA
```

Corregimos los tipos de los datos.

```{r}
jobs$Date <- as.Date(jobs$Date, format="%Y-%m-%d")
jobs$Solicitudes <- as.numeric(jobs$Solicitudes)
jobs$Visualizaciones <- as.numeric(jobs$Visualizaciones)
sum(is.na(jobs))
```

Mostramos la distribución de los valores perdidos.

```{r}
aggr(jobs, numbers=TRUE, sortVars=TRUE, labels=names(jobs),
cex.axis=.7, gap=3, ylab=c("Missing data","Pattern"))
```

```{r}
summary(jobs)
```


```{r}
head(jobs, 10)
```

```{r}
tail(jobs, 10)
```

```{r}
world_map <- map_data("world")
ggplot(world_map, aes(x = long, y = lat, group = group)) +
  geom_polygon(fill="lightgray", colour = "white")

world <- map_data("world")
head(world)

locs <- c('Jiron Cuzco 423, Magdalena del Mar', 'Av Nicolas Arriola 500, La Victoria')
geocode(locs)

geocodeAdddress <- function(address) {
  require(RJSONIO)
  url <- "http://maps.google.com/maps/api/geocode/json?address="
  url <- URLencode(paste(url, address, "&sensor=false", sep = ""))
  x <- fromJSON(url, simplify = FALSE)
  if (x$status == "OK") {
    out <- c(x$results[[1]]$geometry$location$lng,
             x$results[[1]]$geometry$location$lat)
  } else {
    out <- NA
  }
  Sys.sleep(0.2)  # API only allows 5 requests per second
  out
}
geocodeAdddress("Time Square, New York City")

# Loop through the addresses to get the latitude and longitude of each address and add it to the
# origAddress data frame in new columns lat and lon
for(i in 1:nrow(jobs)){
  # Print("Working...")
  result <- geocode(jobs$Location[i], output = "latlona", source = "google")
  jobs$lon[i] <- as.numeric(result[1])
  jobs$lat[i] <- as.numeric(result[2])
  jobs$geoAddress[i] <- as.character(result[3])
}
# Write a CSV file containing origAddress to the working directory
write.csv(jobs, "geocoded.csv", row.names=FALSE)

library(tmaptools)
pubs_tmaptools <- geocode_OSM(Scotland$Location, details = TRUE, as.data.frame = TRUE)
#Eliminar si contiene alrededores la localizacion
Spain <- Spain[!grepl("alrededores", Spain[["Location"]]), ]
# Eliminar y alrededores
library(tidyverse)
Spain$Location <- str_remove(Spain$Location, "^*y alrededores.*$")
Spain$Location[which(Spain$Location == "Greater Barcelona Metropolitan Area")] <- "Barcelona"
pubs_tmaptools2 <- geocode_OSM(Spain$Location, details = TRUE, as.data.frame = TRUE)

Scotland<-merge(x=Scotland,y=pubs_tmaptools, by = 0, all= TRUE)
Scotland<-na.omit(Scotland)

library(stringi)
Spain<-merge(x=Spain,y=pubs_tmaptools2, by = 0, all= TRUE)
Spain<-na.omit(Spain)

NI <- map_data("world") %>%
  filter(region == "Spain")

library(plotly)
library(viridis)
p <- Spain %>%
  ggplot() +
    geom_polygon(data = NI, aes(x=long, y = lat, group = group), fill="grey", alpha=0.3) +
    geom_count(aes(x=lon, y=lat)) +
    scale_size_continuous(range=c(1,15)) +
    scale_color_viridis(option="inferno") +
    theme_void() +
    ylim(35,45) +
    coord_map() +
    theme(legend.position = "none")
p

NI <- map_data("world") %>%
  filter(region == "UK")
p <- Scotland %>%
  ggplot() +
    geom_polygon(data = NI, aes(x=long, y = lat, group = group), fill="grey", alpha=0.3) +
    geom_count(aes(x=lon, y=lat)) +
    scale_size_continuous(range=c(1,3)) +
    scale_color_viridis(option="inferno") +
    theme_void() +
    coord_map() +
    theme(legend.position = "none")
p

library(tmaptools)
WorldWide$Location[which(WorldWide$Location == "Cracow, Lesser Poland District, Poland")] <- "Cracow, Poland"
WorldWide$Location[which(WorldWide$Location == "Barcelona y alrededores")] <- "Barcelona, Spain"
WorldWide$Location[which(WorldWide$Location == "New York City Metropolitan Area")] <- "New York"
WorldWide$Location[which(WorldWide$Location == "Hong Kong, Hong Kong SAR")] <- "Hong Kong"
WorldWide$Location[which(WorldWide$Location == "Burnaby (Maywood / Marlborough / Oakalla / Windsor), V5H, CA")] <- "Burnaby"
WorldWide$Location[which(WorldWide$Location == "District Brno-City, Czech Republic")] <- "Czech Republic"
WorldWide$Location[which(WorldWide$Location == "Silkeborg, Middle Jutland, Denmark")] <- "Denmark"
WorldWide$Location[which(WorldWide$Location == "Prague, The Capital, Czech Republic")] <- "Prague"
WorldWide$Location[which(WorldWide$Location == "Kuala Lumpur, Federal Territory of Kuala Lumpur, Malaysia")] <- "Malaysia"
WorldWide$Location[which(WorldWide$Location == "Genève et périphérie")] <- "Genève"
WorldWide$Location[which(WorldWide$Location == "Dallas-Fort Worth Metroplex")] <- "Dallas"
WorldWide$Location[which(WorldWide$Location == "Raleigh-Durham-Chapel Hill Area")] <- "Raleigh"
WorldWide$Location[which(WorldWide$Location == "Santiago de Compostela y alrededores")] <- "Santiago de Compostela"
WorldWide$Location[which(WorldWide$Location == "Herzliyya, Tel Aviv, Israel")] <- "Herzliya"
WorldWide$Location[which(WorldWide$Location == "New Territories, Hong Kong SAR")] <- "Hong Kong"
# No results found for "Cracow, Lesser Poland District, Poland".
# No results found for "Barcelona y alrededores".
# No results found for "New York City Metropolitan Area".
# No results found for "Hong Kong, Hong Kong SAR".
# No results found for "New York City Metropolitan Area".
# No results found for "Burnaby (Maywood / Marlborough / Oakalla / Windsor), V5H, CA".
# No results found for "District Brno-City, Czech Republic".
# No results found for "New York City Metropolitan Area".
# No results found for "Silkeborg, Middle Jutland, Denmark".
# No results found for "Prague, The Capital, Czech Republic".
# No results found for "Kuala Lumpur, Federal Territory of Kuala Lumpur, Malaysia".
# No results found for "Genève et périphérie".
# No results found for "Dallas-Fort Worth Metroplex".
# No results found for "Dallas-Fort Worth Metroplex".
# No results found for "Raleigh-Durham-Chapel Hill Area".
# No results found for "Santiago de Compostela y alrededores".
# No results found for "Herzliyya, Tel Aviv, Israel".
# No results found for "New Territories, Hong Kong SAR".
pubs_tmaptools3 <- geocode_OSM(WorldWide$Location, details = TRUE, as.data.frame = TRUE)
WorldWide<-merge(x=WorldWide,y=pubs_tmaptools3, by = 0, all= TRUE)
WorldWide<-na.omit(WorldWide)
NI <- map_data("world")
p <- WorldWide %>%
  ggplot() +
    geom_polygon(data = NI, aes(x=long, y = lat, group = group), fill="grey", alpha=0.3) +
    geom_count(aes(x=lon, y=lat)) +
    scale_size_continuous(range=c(0.01,3)) +
    scale_color_viridis(option="inferno") +
    theme_void() +
    coord_map() +
    theme(legend.position = "none")
p

Remote$Location[which(Remote$Location == "Raleigh-Durham-Chapel Hill Area")] <- "Raleigh"
Remote$Location[which(Remote$Location == "New York City Metropolitan Area")] <- "New York"
Remote$Location[which(Remote$Location == "Des Moines Metropolitan Area")] <- "Des Moines"
Remote$Location[which(Remote$Location == "Greater Minneapolis-St. Paul Area")] <- "Minneapolis"
Remote$Location[which(Remote$Location == "Greater Munich Metropolitan Area")] <- "Munich"
Remote$Location[which(Remote$Location == "Gurgaon Sub-District, Haryana, India")] <- "Gurgaon"
Remote$Location[which(Remote$Location == "Barcelona y alrededores")] <- "Barcelona"
Remote$Location[which(Remote$Location == "Dallas-Fort Worth Metroplex")] <- "Dallas"
Remote$Location[which(Remote$Location == "Village of Mayfield, OH, US")] <- "Cleveland"
Remote$Location[which(Remote$Location == "Kraków i okolice")] <- "Kraków"
# No results found for "New York City Metropolitan Area".
# No results found for "Raleigh-Durham-Chapel Hill Area".
# No results found for "New York City Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "Des Moines Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "Greater Minneapolis-St. Paul Area".
# No results found for "New York City Metropolitan Area".
# No results found for "Greater Munich Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "Gurgaon Sub-District, Haryana, India".
# No results found for "Barcelona y alrededores".
# No results found for "New York City Metropolitan Area".
# No results found for "Dallas-Fort Worth Metroplex".
# No results found for "Village of Mayfield, OH, US".
# No results found for "New York City Metropolitan Area".
# No results found for "Dallas-Fort Worth Metroplex".
# No results found for "Greater Minneapolis-St. Paul Area".
# No results found for "New York City Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "New York City Metropolitan Area".
# No results found for "Dallas-Fort Worth Metroplex".
# No results found for "New York City Metropolitan Area".
# No results found for "Kraków i okolice".
pubs_tmaptools4 <- geocode_OSM(Remote$Location, details = TRUE, as.data.frame = TRUE)
Remote<-merge(x=Remote,y=pubs_tmaptools4, by = 0, all= TRUE)
Remote<-na.omit(Remote)
NI <- map_data("world")
p <- Remote %>%
  ggplot() +
    geom_polygon(data = NI, aes(x=long, y = lat, group = group), fill="grey", alpha=0.3) +
    geom_count(aes(x=lon, y=lat)) +
    scale_size_continuous(range=c(0.01,3)) +
    scale_color_viridis(option="inferno") +
    theme_void() +
    coord_map() +
    theme(legend.position = "none")
p


```
